{"version":3,"sources":["../src/typescript/typescript-analyzer.ts"],"names":[],"mappings":"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","file":"typescript-analyzer.js","sourcesContent":["/**\n * @license\n * Copyright (c) 2016 The Polymer Project Authors. All rights reserved.\n * This code may only be used under the BSD style license found at\n * http://polymer.github.io/LICENSE.txt\n * The complete set of authors may be found at\n * http://polymer.github.io/AUTHORS.txt\n * The complete set of contributors may be found at\n * http://polymer.github.io/CONTRIBUTORS.txt\n * Code distributed by Google as part of the polymer project is also\n * subject to an additional IP rights grant found at\n * http://polymer.github.io/PATENTS.txt\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as ts from 'typescript';\n\nimport {AnalysisContext} from '../core/analysis-context';\nimport {LanguageAnalyzer} from '../core/language-analyzer';\nimport {PackageRelativeUrl, ResolvedUrl} from '../model/url';\n\nimport {ParsedTypeScriptDocument} from './typescript-document';\n\nconst _compilerOptions: ts.CompilerOptions = {\n  allowJs: true,\n  emit: false,\n  lib: ['ES2017', 'DOM'],\n};\n\nexport class TypeScriptAnalyzer implements LanguageAnalyzer<ts.Program> {\n  private _context: AnalysisContext;\n\n  constructor(analysisContext: AnalysisContext) {\n    this._context = analysisContext;\n  }\n\n  analyze(url: string): ts.Program {\n    const host = new AnalyzerCompilerHost(this._context);\n    return ts.createProgram([url], _compilerOptions, host);\n  }\n}\n\n// This is mainly for telling the compiler the directory that the\n// lib files are in.\nconst defaultLib = '/$lib/lib.es2017.d.ts';\n\nconst tsLibPath = path.dirname(require.resolve('typescript'));\n\nfunction isLibraryPath(filename: string) {\n  return filename.startsWith('/$lib/');\n}\n\nconst libraryCache = new Map<string, string|undefined>();\nfunction getLibrarySource(filePath: string) {\n  if (libraryCache.has(filePath)) {\n    return libraryCache.get(filePath);\n  }\n  let libFileName = filePath.substring('/$lib/'.length).toLowerCase();\n  if (!libFileName.startsWith('lib.')) {\n    libFileName = `lib.${libFileName}`;\n  }\n  const libPath = path.resolve(tsLibPath, libFileName);\n  let source;\n  try {\n    source = fs.readFileSync(libPath, {encoding: 'utf-8'});\n  } catch (e) {\n    // not found\n  }\n  libraryCache.set(filePath, source);\n  return source;\n}\n\n/**\n * A TypeScript CompilerHost that reads files from an AnalysisContext.\n */\nclass AnalyzerCompilerHost implements ts.CompilerHost {\n  context: AnalysisContext;\n\n  constructor(context: AnalysisContext) {\n    this.context = context;\n  }\n\n  getSourceFile(\n      fileName: PackageRelativeUrl, languageVersion: ts.ScriptTarget,\n      onError?: (message: string) => void): ts.SourceFile {\n    if (isLibraryPath(fileName)) {\n      const libSource = getLibrarySource(fileName);\n      if (libSource != null) {\n        return ts.createSourceFile(fileName, libSource, languageVersion);\n      }\n      // We don't call onError for library paths because the compiler asks for\n      // many paths speculatively. Returning null is sufficient.\n    } else {\n      // This method will be called during analysis, but after all files\n      // in the dependency graph have been loaded, so it can call a synchronous\n      // method to get the source of a file.\n      const scannedDocument =\n          this.context._getScannedDocument(this._failSafeResolveUrl(fileName));\n      if (scannedDocument != null) {\n        const typescriptDocument =\n            scannedDocument.document as ParsedTypeScriptDocument;\n        return typescriptDocument.ast as ts.SourceFile;\n      }\n      if (onError) {\n        onError('not found');\n      }\n    }\n    // tslint:disable-next-line: no-any\n    return null as any as ts.SourceFile;\n  }\n\n  getDefaultLibFileName() {\n    return defaultLib;\n  }\n\n  get writeFile(): ts.WriteFileCallback {\n    return (_fileName: string,\n            _data: string,\n            _writeByteOrderMark: boolean,\n            _onError?: (message: string) => void,\n            _sourceFiles?: ReadonlyArray<ts.SourceFile>): void => {\n      throw new Error('unsupported operation');\n    };\n  }\n\n  getCurrentDirectory() {\n    // Seems to work best\n    return '';\n  }\n\n  getDirectories(_path: string): string[] {\n    // Seems to work best\n    return [''];\n  }\n\n  getCanonicalFileName(fileName: PackageRelativeUrl) {\n    return this._failSafeResolveUrl(fileName);\n  }\n\n  getNewLine() {\n    return ts.sys.newLine;\n  }\n\n  useCaseSensitiveFileNames() {\n    return true;\n  }\n\n  fileExists(fileName: PackageRelativeUrl) {\n    const resolvedUrl = this._failSafeResolveUrl(fileName);\n    return isLibraryPath(resolvedUrl) &&\n        getLibrarySource(resolvedUrl) != null ||\n        this.context._getScannedDocument(resolvedUrl) != null;\n  }\n\n  readFile(fileName: PackageRelativeUrl): string {\n    const resolvedUrl = this._failSafeResolveUrl(fileName);\n    if (isLibraryPath(resolvedUrl)) {\n      const libPath = require.resolve(`typescript/lib/${fileName}`);\n      return fs.readFileSync(libPath, {encoding: 'utf-8'});\n    }\n    const document = this.context._getScannedDocument(resolvedUrl);\n    // tslint:disable-next-line: no-any\n    return (document) ? document.document.contents : null as any as string;\n  }\n\n  resolveModuleNames(moduleNames: string[], containingFile: string):\n      ts.ResolvedModule[] {\n    return moduleNames.map((moduleName) => {\n      // We only support path resolution, not node resolution\n      if (!(moduleName.startsWith('./') || moduleName.startsWith('../') ||\n            moduleName.startsWith('/'))) {\n        // tslint:disable-next-line: no-any\n        return {resolvedFileName: null as any as string};\n      }\n      // since we have a path, we can simply resolve it\n      const fileName = path.resolve(path.dirname(containingFile), moduleName) as\n          PackageRelativeUrl;\n      const resolvedFileName = this._failSafeResolveUrl(fileName);\n      return {resolvedFileName};\n    });\n  }\n\n  /**\n   * Resolves the given url.\n   *\n   * If the url is unresolvable, the given unresolved URL is returned as a\n   * resolved URL.\n   */\n  private _failSafeResolveUrl(url: string): ResolvedUrl {\n    const resolved = this.context.resolver.resolve(url as PackageRelativeUrl);\n    // tslint:disable-next-line: no-any\n    return resolved === undefined ? url as any as ResolvedUrl : resolved;\n  }\n}\n"]}