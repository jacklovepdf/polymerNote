{"version":3,"sources":["../src/css/css-custom-property-scanner.ts"],"names":[],"mappings":"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","file":"css-custom-property-scanner.js","sourcesContent":["/**\n * @license\n * Copyright (c) 2017 The Polymer Project Authors. All rights reserved.\n * This code may only be used under the BSD style license found at\n * http://polymer.github.io/LICENSE.txt\n * The complete set of authors may be found at\n * http://polymer.github.io/AUTHORS.txt\n * The complete set of contributors may be found at\n * http://polymer.github.io/CONTRIBUTORS.txt\n * Code distributed by Google as part of the polymer project is also\n * subject to an additional IP rights grant found at\n * http://polymer.github.io/PATENTS.txt\n */\n\nimport * as shady from 'shady-css-parser';\n\nimport {ImmutableArray} from '../model/immutable';\nimport {CssAstNode, Feature, ScannedFeature, SourceRange, Warning} from '../model/model';\n\nimport {ParsedCssDocument, Visitor} from './css-document';\nimport {CssScanner} from './css-scanner';\n\nexport class CssCustomPropertyScanner implements CssScanner {\n  async scan(\n      document: ParsedCssDocument, visit: (visitor: Visitor) => Promise<void>) {\n    const warnings: Warning[] = [];\n\n    const visitor = new CssCustomPropertyVisitor(document);\n    await visit(visitor);\n\n    return {features: visitor.features, warnings};\n  }\n}\n\ndeclare module '../model/queryable' {\n  interface FeatureKindMap {\n    'css-custom-property-assignment': CssCustomPropertyAssignment;\n  }\n}\n\nexport class CssCustomPropertyAssignment implements ScannedFeature, Feature {\n  readonly sourceRange: SourceRange;\n  readonly warnings: ImmutableArray<Warning> = [];\n  readonly kinds = new Set(['css-custom-property-assignment']);\n  readonly identifiers: Set<string>;\n  readonly name: string;\n  readonly astNode: CssAstNode;\n\n  constructor(name: string, sourceRange: SourceRange, astNode: CssAstNode) {\n    this.identifiers = new Set([name]);\n    this.name = name;\n    this.sourceRange = sourceRange;\n    this.astNode = astNode;\n  }\n\n  resolve() {\n    return this;\n  }\n}\n\ndeclare module '../model/queryable' {\n  interface FeatureKindMap {\n    'css-custom-property-use': CssCustomPropertyUse;\n  }\n}\n\nexport class CssCustomPropertyUse implements ScannedFeature, Feature {\n  readonly sourceRange: SourceRange;\n  readonly warnings: ImmutableArray<Warning> = [];\n  readonly kinds = new Set(['css-custom-property-use']);\n  readonly identifiers: Set<string>;\n  readonly name: string;\n  readonly astNode: CssAstNode;\n\n  constructor(name: string, sourceRange: SourceRange, astNode: CssAstNode) {\n    this.identifiers = new Set([name]);\n    this.sourceRange = sourceRange;\n    this.name = name;\n    this.astNode = astNode;\n  }\n\n  resolve() {\n    return this;\n  }\n}\n\n\nclass CssCustomPropertyVisitor implements Visitor {\n  features: CssCustomPropertyAssignment[] = [];\n  constructor(private document: ParsedCssDocument) {\n  }\n\n  visit(node: shady.Node): void {\n    if (node.type === shady.nodeType.declaration &&\n        node.name.startsWith('--')) {\n      this.features.push(new CssCustomPropertyAssignment(\n          node.name,\n          this.document.sourceRangeForShadyRange(node.nameRange),\n          {language: 'css', node, containingDocument: this.document}));\n    } else if (node.type === shady.nodeType.expression) {\n      this.getCustomPropertiesIn(node, node.text, node.range);\n    } else if (node.type === shady.nodeType.atRule && node.parametersRange) {\n      this.getCustomPropertiesIn(node, node.parameters, node.parametersRange);\n    }\n  }\n\n  private static readonly customPropRegex = /--[A-Za-z0-9_\\-]+/;\n  private getCustomPropertiesIn(\n      node: shady.Node, text: string, range: shady.Range) {\n    const matches =\n        findAllMatchesInString(CssCustomPropertyVisitor.customPropRegex, text);\n    const baseOffset = range.start;\n    for (const {offset, matched} of matches) {\n      const range = this.document.sourceRangeForShadyRange({\n        start: offset + baseOffset,\n        end: offset + baseOffset + matched.length\n      });\n      this.features.push(new CssCustomPropertyUse(\n          matched,\n          range,\n          {language: 'css', node, containingDocument: this.document}));\n    }\n  }\n}\n\nfunction* findAllMatchesInString(regex: RegExp, haystack: string) {\n  regex = new RegExp(regex, 'g');\n  let match;\n  while (match = regex.exec(haystack)) {\n    yield {offset: match.index, matched: match[0]};\n  }\n}\n"]}